@using Shop.Web.Extension
@model Shop.Web.ViewModels.ProductDetailsViewModel

@if (Model != null)
{
    <div class="container-fluid">
        <div class="row spaced">
            <div class="container-fluid">
                <div class="col-md-2 product-details-img"> 
                    <img src="@Url.Content("~/Resources/Images/no-image-available-150.png")" />
                </div>
                <div class="col-md-8 product-details-info">
                    <div class="container-fluid">
                        <div class="form-group row">
                            <div class="col-md-3 inline-block">
                                @Html.LabelFor(model => model.Name)
                            </div>
                            <span>@Model.Name</span>
                        </div>
                        <div class="form-group row">
                            <div class="col-md-3 inline-block">
                                @Html.LabelFor(model => model.ID)
                            </div>
                            <span>@Model.ID</span>
                        </div>
                        <div class="form-group row">
                            <div class="col-md-3 inline-block">
                                @Html.LabelFor(model => model.Description)
                            </div>
                            <span>@Model.Description</span>
                        </div>
                        <div class="form-group row">
                            <div class="col-md-3 inline-block">
                                <label>Поставка</label>
                            </div>
                            <span><i>(Поставка не выбрана!)</i></span>
                            <a href="javascript:DisplayConsignments('@Model.ID');">Выбрать поставку</a>
                            @Html.EntityEditor(model => model.Consignment)
                        </div>
                        <div class="form-group row">
                            <div class="col-md-3 inline-block">
                                <label>Количество</label>
                            </div>
                            <input class="form-control inline-block small-number" type="number" value="0" id="txtCount" min="0" max="@Model.ItemsAvailable" />
                        </div>
                        <div class="row">
                            <div class="container-fluid no-padding">
                                <button type="button" onclick="AddProductToBasket('@Model.ID');" class="btn btn-success">Добавить в корзину</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 container-fluid">
                <ul class="nav nav-tabs">
                    <li class="active">
                        <a href="#1" data-toggle="tab">Основная информация</a>
                    </li>
                    <li>
                        <a href="#2" data-toggle="tab">Полные характеристики</a>
                    </li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane active" id="1">
                        @Model.Description
                    </div>
                    <div class="tab-pane" id="2">
                        @{
                            var mdl = new Shop.Web.ViewModels.Categories.SpinningRodCategorySpecification();
                            @Html.CreateSpecification(mdl);
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        function AddProductToBasket(id)
        {
            var count = $("#txtCount").val();
            if (count <= 0) return;
            $.ajax({
                method: "GET",
                url: "@Url.Action("AjaxAddProduct", "Basket")?productId=" + id + "&count=" + count,
                dataType: 'json',
                success: function(data)
                {
                    PopUpWindow.open('Добавление в корзину', data.Message, ((data.Success) ? "popUp-success" : "popUp-failed"));
                }
            });
        }

        function DisplayConsignments(id)
        {
            var productId = id;
            $.ajax({
                method: "GET",
                url: "@Url.Action("AjaxGetProductConsignments", "Consignment")?productId=" + productId,
                dataType: 'json',
                success: function(data)
                {
                    if (!data.Success)
                    {
                        PopUpWindow.open('Ошибка!', data.Message, "popUp-failed");
                        return;
                    }
                    var json = {};
                    json = new Array();
                    var identity = new Array();
                    for (var i = 0; i < data.Result.Items.length; i++)
                    {
                        json[i] = new Array();
                        json[i][0] = i + 1;
                        json[i][1] = data.Result.Items[i].CreationDate;
                        json[i][2] = data.Result.Items[i].Count;
                        json[i][3] = data.Result.Items[i].Cost;
                        identity[i] = data.Result.Items[i].ID;
                    }
                    console.log(json);
                    PopUpWindow.open('Выбрать поставку', '<div id="consignment_selection"></div>');
                    $("#consignment_selection").Table({
                        model: [
                            { name: "#", type: "number" },
                            { name: "Дата создания", type: "datetime" },
                            { name: "Количество на складе", type: "number", align: "center" },
                            { name: "Цена", type: "number" }
                        ],
                        data: json,
                        identity: identity,
                        rowsPerPage: 15,
                        onRowSelect: function (instance, id) {
                            PopUpWindow.close();
                            console.log(productId);
                            $.ajax({
                                method: "GET",
                                url: "@Url.Action("AjaxSelectConsignment", "Consignment")?consignmentId=" + id + "&productId=" + productId,
                                dataType: 'json',
                                success: function (data) {
                                    console.log(data);
                                    if (!data.Success) {
                                        PopUpWindow.open('Ошибка!', data.Message, "popUp-failed");
                                        return;
                                    }

                                }
                            });
                        }
                    });
                },
                failed: function () {
                    console.log('failed!');
                }
            });
        }

        function ApplyConsignment(id)
        {
            console.log(id);
        }
    </script>    
}
else
{
    <span>Продукт не найден!</span>
}